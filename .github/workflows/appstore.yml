name: Build Mac Catalyst App
on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: macos-14

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Certificates
      env:
        DIST_CERT: ${{ secrets.MAC_CERTIFICATE }}
        INSTALL_CERT: ${{ secrets.MAC_INSTALLER_CERTIFICATE }}
        CERT_PASSWORD: ${{ secrets.MAC_CERTIFICATE_PASSWORD }}
        PROFILE: ${{ secrets.MAC_PROVISION_PROFILE }}
      run: |
        KEYCHAIN=build.keychain
        security create-keychain -p "" $KEYCHAIN
        security default-keychain -s $KEYCHAIN
        security unlock-keychain -p "" $KEYCHAIN

        echo "$DIST_CERT" | base64 --decode > dist.p12
        echo "$INSTALL_CERT" | base64 --decode > installer.p12
        echo "$PROFILE" | base64 --decode > profile.provisionprofile

        security import dist.p12 -k $KEYCHAIN -P "$CERT_PASSWORD" -T /usr/bin/codesign
        security import installer.p12 -k $KEYCHAIN -P "$CERT_PASSWORD" -T /usr/bin/pkgbuild

        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp profile.provisionprofile ~/Library/MobileDevice/Provisioning\ Profiles/

    - name: Build Archive
      run: |
        xcodebuild archive \
          -scheme Chimie \
          -destination "generic/platform=macOS" \
          -archivePath build/Chimie-MacCatalyst.xcarchive \
          COMPILER_INDEX_STORE_ENABLE=NO \
          -allowProvisioningUpdates

    - name: Export App
      run: |
        xcodebuild -exportArchive \
          -archivePath build/Chimie-MacCatalyst.xcarchive \
          -exportOptionsPlist ExportOptions.plist \
          -exportPath build

    - name: Upload to App Store Connect
      run: |
        xcrun altool --upload-app \
          --type macos \
          --file build/*.pkg \
          --apiKey ${{ secrets.APPSTORE_KEY_ID }} \
          --apiIssuer ${{ secrets.APPSTORE_ISSUER_ID }}
