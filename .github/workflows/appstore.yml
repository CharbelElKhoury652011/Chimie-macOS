name: Build & Upload Mac Catalyst App

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: "16.2"

    - name: Create keychain and import certificates
      env:
        DIST_CERT: ${{ secrets.MAC_CERTIFICATE }}
        INSTALL_CERT: ${{ secrets.MAC_INSTALLER_CERTIFICATE }}
        CERT_PASSWORD: ${{ secrets.MAC_CERTIFICATE_PASSWORD }}
        PROFILE: ${{ secrets.MAC_PROVISION_PROFILE }}
      run: |
        KEYCHAIN=build.keychain

        security create-keychain -p "buildpass" $KEYCHAIN
        security set-keychain-settings -t 3600 -u $KEYCHAIN
        security unlock-keychain -p "buildpass" $KEYCHAIN
        security default-keychain -s $KEYCHAIN

        echo "$DIST_CERT" | base64 --decode > dist.p12
        echo "$INSTALL_CERT" | base64 --decode > installer.p12
        echo "$PROFILE" | base64 --decode > profile.mobileprovision

        security import dist.p12 -k $KEYCHAIN -P "$CERT_PASSWORD" -T /usr/bin/codesign
        security import installer.p12 -k $KEYCHAIN -P "$CERT_PASSWORD" -T /usr/bin/pkgbuild

        security set-key-partition-list -S apple-tool:,apple: -s -k "buildpass" $KEYCHAIN

        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

    - name: Build Archive (Mac Catalyst)
      run: |
        xcodebuild archive \
          -scheme Chimie \
          -destination "generic/platform=macOS" \
          -archivePath build/Chimie.xcarchive \
          CODE_SIGN_STYLE=Manual \
          CODE_SIGN_IDENTITY="Apple Distribution" \
          PROVISIONING_PROFILE_SPECIFIER="Chimie macOS Provisioning Profile" \
          COMPILER_INDEX_STORE_ENABLE=NO

    - name: Export for Mac App Store
      run: |
        xcodebuild -exportArchive \
          -archivePath build/Chimie.xcarchive \
          -exportOptionsPlist ExportOptions.plist \
          -exportPath build \
          -allowProvisioningUpdates \
          -verbose
          
    - name: Save XCArchive as artifact
      uses: actions/upload-artifact@v4
      with:
        name: ChimieMacArchive
        path: build/Chimie.xcarchive

